<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Benchmarks of HMM routines</title>
    <meta name="description" content="Benchmarks for HMM calculations in R/qtl2">
    <meta name="author" content="Karl Broman">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="http://kbroman.org/qtl2/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="http://kbroman.org/qtl2/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="http://kbroman.org/qtl2/assets/themes/twitter/css/kbroman.css" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->

    <!-- atom & rss feed -->
    <link href="http://kbroman.org/qtl2nil" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="http://kbroman.org/qtl2nil" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <a class="brand" href="http://kbroman.org/qtl2">R/qtl2</a>

          <ul class="nav">
              <li><a href="http://kbroman.org/qtl2/assets/vignettes/user_guide.html">user guide</a></li>
              <li><a href="http://kbroman.org/qtl2/assets/vignettes/input_files.html">input files</a></li>
              <li><a href="http://kbroman.org/qtl2/pages/sampledata.html">sample data</a></li>
          </ul>

        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="content">


<div class="page-header">
  <h2>Benchmarks of HMM routines</h2>
</div>

<div class="row-fluid">
  <div class="span12">
<div><div> <!-- useless divs to match 2 extra </div> at the end -->






<p><a href="https://github.com/kbroman/qtl2geno">R/qtl2geno</a> includes a reimplementation of the basic hidden Markov model code for the calculation of conditional genotype probabilities (given the available multipoint marker genotype data) and the estimation of genetic maps.</p>
<p>The new HMM code can potentially handle more general cases and uses C++ classes to simplify the extension to new cross types. I’ve also split out the forward and backward equations as separate functions, to reduce code duplication. And the basic calculations are separated by individual, which may allow for low-level parallel processing (i.e., <a href="https://en.wikipedia.org/wiki/Concurrency_(computer_science)">concurrency</a>). (I’m considered using <a href="http://dirk.eddelbuettel.com/blog/2014/07/16/#introducing_rcppparallel">RcppParallel</a> for this.)</p>
<p>The new code for calculating conditional genotype probabilities is about the same as that in <a href="https://rqtl.org">R/qtl</a>. The new code for estimating the genetic map, on the other hand, is considerably slower than that in <a href="https://rqtl.org">R/qtl</a>. The present document provides detailed benchmarks on this point.</p>
<div id="genotype-probabilities" class="section level2">
<h2>Genotype probabilities</h2>
<p>First let’s look at the calculation of conditional genotype probabilities (given multiple genetic marker genotypes). We’ll consider simulated data, first of a backcross with 500 individuals (250 males and 250 females) and with markers at a 1 cM spacing on 20 chromosomes (including the X chromosome), and 5% missing data. We use <code>qtl::sim.map()</code> and <code>qtl:sim.cross()</code> to simulate the data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">8440561</span>)
<span class="kw">library</span>(qtl)
<span class="kw">data</span>(map10)
chrL &lt;-<span class="st"> </span><span class="kw">round</span>(<span class="kw">summary</span>(map10)$length[<span class="dv">1</span>:<span class="dv">20</span>])
map &lt;-<span class="st"> </span><span class="kw">sim.map</span>(<span class="dt">len=</span>chrL, <span class="dt">n.mar=</span>chrL<span class="dv">+1</span>, <span class="dt">include.x=</span><span class="ot">TRUE</span>, <span class="dt">eq.spacing=</span><span class="ot">TRUE</span>)
n &lt;-<span class="st"> </span><span class="dv">500</span>
bc &lt;-<span class="st"> </span><span class="kw">sim.cross</span>(map, <span class="dt">n.ind=</span>n, <span class="dt">type=</span><span class="st">&quot;bc&quot;</span>, <span class="dt">missing.prob=</span><span class="fl">0.05</span>)
bc$pheno$sex &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">0</span>:<span class="dv">1</span>, <span class="dt">each=</span>n/<span class="dv">2</span>)</code></pre></div>
<p>There’s a total of 1685 markers.</p>
<p>We use <code>qtl2geno::convert2cross2()</code> to convert the data to the format for <a href="http://kbroman.org/qtl2">R/qtl2</a>. Also, with R/qtl2, I need to use <code>insert_pseudomarkers</code> to create a map with pseudomarkers inserted, prior to running <code>calc_genoprob</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(qtl2geno)
bc2 &lt;-<span class="st"> </span><span class="kw">convert2cross2</span>(bc)
bc2_pmarkmap &lt;-<span class="st"> </span>qtl2geno::<span class="kw">insert_pseudomarkers</span>(bc2$gmap, <span class="dt">step=</span><span class="fl">0.5</span>)</code></pre></div>
<p>We use the <a href="https://cran.r-project.org/package=microbenchmark">microbenchmark package</a> and run each of <code>qtl::calc.genoprob()</code> and <code>qtl2geno::calc_genoprob2()</code> 25 times, with calculations at a 0.5 cM spacing. Even though the data were simulated without genotyping errors, I’m going to do the calculations assuming a 0.2% genotype error rate.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(microbenchmark)
probbc &lt;-<span class="st"> </span><span class="kw">microbenchmark</span>(<span class="dt">qtl =</span>  qtl::<span class="kw">calc.genoprob</span>(bc, <span class="dt">step=</span><span class="fl">0.5</span>, <span class="dt">error.prob=</span><span class="fl">0.002</span>),
                         <span class="dt">qtl2 =</span> qtl2geno::<span class="kw">calc_genoprob</span>(bc2, bc2_pmarkmap, <span class="dt">error_prob=</span><span class="fl">0.002</span>),
                         <span class="dt">times=</span><span class="dv">25</span>)
<span class="kw">print</span>(probbc, <span class="dt">unit=</span><span class="st">&quot;s&quot;</span>)</code></pre></div>
<pre><code>## Unit: seconds
##  expr       min       lq      mean    median        uq      max neval cld
##   qtl 1.0420229 1.049512 1.0897630 1.0588333 1.0749538 1.583892    25   b
##  qtl2 0.8447251 0.860328 0.8879964 0.8666601 0.8758329 1.076109    25  a</code></pre>
<p>Let’s do the same for an intercross, also including the X chromosome, and with crosses in both directions and with both sexes. Again, with R/qtl2, I need to use <code>insert_pseudomarkers</code> to create a map with pseudomarkers inserted, prior to running <code>calc_genoprob</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">f2 &lt;-<span class="st"> </span><span class="kw">sim.cross</span>(map, <span class="dt">n.ind=</span>n, <span class="dt">type=</span><span class="st">&quot;f2&quot;</span>, <span class="dt">missing.prob=</span><span class="fl">0.05</span>)
f2$pheno$sex &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">0</span>:<span class="dv">1</span>, <span class="dt">each=</span>n/<span class="dv">2</span>)
f2$pheno$pgm &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">0</span>:<span class="dv">1</span>, n/<span class="dv">2</span>)
f2_2 &lt;-<span class="st"> </span><span class="kw">convert2cross2</span>(f2)
f2_2_pmarkmap &lt;-<span class="st"> </span>qtl2geno::<span class="kw">insert_pseudomarkers</span>(f2_2$gmap, <span class="dt">step=</span><span class="fl">0.5</span>)</code></pre></div>
<p>Now for the benchmarks; we’ll do the calculations just 10 times.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">probf2 &lt;-<span class="st"> </span><span class="kw">microbenchmark</span>(<span class="dt">qtl =</span>  qtl::<span class="kw">calc.genoprob</span>(f2, <span class="dt">step=</span><span class="fl">0.5</span>, <span class="dt">error.prob=</span><span class="fl">0.002</span>),
                         <span class="dt">qtl2 =</span> qtl2geno::<span class="kw">calc_genoprob</span>(f2_2, f2_2_pmarkmap, <span class="dt">error_prob=</span><span class="fl">0.002</span>),
                         <span class="dt">times=</span><span class="dv">10</span>)
<span class="kw">print</span>(probf2, <span class="dt">unit=</span><span class="st">&quot;s&quot;</span>)</code></pre></div>
<pre><code>## Unit: seconds
##  expr      min       lq     mean   median       uq      max neval cld
##   qtl 2.506977 2.638704 2.644074 2.643813 2.650559 2.781655    10   b
##  qtl2 1.896741 1.906769 1.925714 1.911452 1.918307 2.036555    10  a</code></pre>
</div>
<div id="genetic-map-estimation" class="section level2">
<h2>Genetic map estimation</h2>
<p>Now let’s consider the estimation of inter-marker distances in the genetic map, with the functions <code>qtl::est.map</code> and <code>qtl2geno::est_map</code>.</p>
<p>First the backcross; to speed things up, we’ll look at just chromosomes 1 and X.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">bc &lt;-<span class="st"> </span>bc[<span class="kw">c</span>(<span class="dv">1</span>, <span class="st">&quot;X&quot;</span>),]
bc2 &lt;-<span class="st"> </span><span class="kw">convert2cross2</span>(bc)</code></pre></div>
<p>Now for the benchmarks. We’ll just do 5 replicates.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mapbc &lt;-<span class="st"> </span><span class="kw">microbenchmark</span>(<span class="dt">qtl =</span>  qtl::<span class="kw">est.map</span>(bc, <span class="dt">error.prob=</span><span class="fl">0.002</span>, <span class="dt">tol=</span><span class="fl">1e-6</span>, <span class="dt">maxit=</span><span class="dv">10000</span>),
                        <span class="dt">qtl2 =</span> qtl2geno::<span class="kw">est_map</span>(bc2, <span class="dt">error_prob=</span><span class="fl">0.002</span>, <span class="dt">tol=</span><span class="fl">1e-6</span>, <span class="dt">maxit=</span><span class="dv">10000</span>),
                        <span class="dt">times=</span><span class="dv">5</span>)
<span class="kw">print</span>(mapbc, <span class="dt">unit=</span><span class="st">&quot;s&quot;</span>)</code></pre></div>
<pre><code>## Unit: seconds
##  expr      min       lq     mean   median       uq      max neval cld
##   qtl 1.505558 1.512556 1.594503 1.514041 1.517071 1.923289     5  a
##  qtl2 1.832302 1.835156 1.869817 1.848742 1.906856 1.926029     5   b</code></pre>
<p>Now to the intercross. Again, we’ll look at just chromosomes 1 and X, and we’ll perform just 5 replicates.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">f2 &lt;-<span class="st"> </span>f2[<span class="kw">c</span>(<span class="dv">1</span>, <span class="st">&quot;X&quot;</span>),]
f2_2 &lt;-<span class="st"> </span><span class="kw">convert2cross2</span>(f2)
mapf2 &lt;-<span class="st"> </span><span class="kw">microbenchmark</span>(<span class="dt">qtl =</span>  qtl::<span class="kw">est.map</span>(f2, <span class="dt">error.prob=</span><span class="fl">0.002</span>, <span class="dt">tol=</span><span class="fl">1e-6</span>, <span class="dt">maxit=</span><span class="dv">10000</span>),
                        <span class="dt">qtl2 =</span> qtl2geno::<span class="kw">est_map</span>(f2_2, <span class="dt">error_prob=</span><span class="fl">0.002</span>, <span class="dt">tol=</span><span class="fl">1e-6</span>, <span class="dt">maxit=</span><span class="dv">10000</span>),
                        <span class="dt">times=</span><span class="dv">5</span>)
<span class="kw">print</span>(mapf2, <span class="dt">unit=</span><span class="st">&quot;s&quot;</span>)</code></pre></div>
<pre><code>## Unit: seconds
##  expr      min       lq     mean   median       uq      max neval cld
##   qtl 4.209004 4.216213 4.220859 4.218208 4.227645 4.233225     5   b
##  qtl2 3.468959 3.478439 3.512348 3.478599 3.481871 3.653874     5  a</code></pre>
<p>For the backcross, the new code takes 1.2 times longer; for the intercross, the new code takes 0.8 times longer.</p>
</div>
<div id="why-the-differences-in-speed" class="section level2">
<h2>Why the differences in speed?</h2>
<p>I made a number of changes to the HMM code between <a href="https://rqtl.org">R/qtl</a> and <a href="http://kbroman.org/qtl2">R/qtl2</a>.</p>
<ul>
<li>Split out the forward/backward equations as separate functions (to avoid code duplication and to make the code potentially clearer).</li>
<li>Calculations are by individual, with an eye towards low-level parallel processing</li>
<li>Things are a bit more general. For example, the transition probabilities in the Markov chain can be completely different for each individual, depending on the <code>cross_info</code> data. Also, the estimation of recombination fractions is potentially cross-specific; this allows us to handle RIL with the same basic code as a backcross.</li>
<li>Using R-style matrix objects (via <a href="http://rcpp.org">Rcpp</a>) rather than low-level C-type arrays.</li>
</ul>
<p>We could just rely on parallel processing to speed things up. (I’ve implemented parallel calculations at the level of chromosomes, using the <a href="https://stat.ethz.ch/R-manual/R-devel/library/parallel/doc/parallel.pdf">parallel</a> package, but we could make more efficient use of available processors by splitting things out at a lower level.) Other alternatives are to have separate implementations for different groups of crosses, or to identify the set of observed <code>cross_info</code> values and pre-calculate emission and transition probabilities for each.</p>
<p>It’s also possible that some basic aspects of my code could be improved, even keeping the overall design fixed. I’m new to C++ and not entirely sure that I’m doing things in the best way.</p>
</div>
<div id="session-information" class="section level2">
<h2>Session information</h2>
<p>The following shows the R and package versions I was using.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">devtools::<span class="kw">session_info</span>()</code></pre></div>
<pre><code>## Session info --------------------------------------------------------------------------------------</code></pre>
<pre><code>##  setting  value
##  version  R version 3.4.1 (2017-06-30)
##  system   x86_64, darwin15.6.0
##  ui       X11
##  language en_US.UTF-8
##  collate  en_US.UTF-8
##  tz       America/Chicago
##  date     2017-09-15</code></pre>
<pre><code>## Packages ------------------------------------------------------------------------------------------</code></pre>
<pre><code>##  package        * version date       source
##  assertthat       0.2.0   2017-04-11 CRAN (R 3.4.0)
##  backports        1.1.0   2017-05-22 CRAN (R 3.4.0)
##  base           * 3.4.1   2017-07-07 local
##  broman         * 0.65-4  2017-05-28 local
##  codetools        0.2-15  2016-10-05 CRAN (R 3.4.0)
##  colorspace       1.3-2   2016-12-14 CRAN (R 3.4.0)
##  compiler         3.4.1   2017-07-07 local
##  data.table       1.10.4  2017-02-01 CRAN (R 3.4.0)
##  datasets       * 3.4.1   2017-07-07 local
##  devtools         1.13.3  2017-08-02 CRAN (R 3.4.1)
##  digest           0.6.12  2017-01-27 CRAN (R 3.4.0)
##  evaluate         0.10.1  2017-06-24 CRAN (R 3.4.0)
##  ggplot2          2.2.1   2016-12-30 CRAN (R 3.4.0)
##  graphics       * 3.4.1   2017-07-07 local
##  grDevices      * 3.4.1   2017-07-07 local
##  grid             3.4.1   2017-07-07 local
##  gtable           0.2.0   2016-02-26 CRAN (R 3.4.0)
##  htmltools        0.3.6   2017-04-28 CRAN (R 3.4.0)
##  knitr            1.17    2017-08-10 CRAN (R 3.4.1)
##  lattice          0.20-35 2017-03-25 CRAN (R 3.4.0)
##  lazyeval         0.2.0   2016-06-12 CRAN (R 3.4.0)
##  magrittr       * 1.5     2014-11-22 CRAN (R 3.4.0)
##  MASS             7.3-47  2017-02-26 CRAN (R 3.4.0)
##  Matrix           1.2-11  2017-08-16 CRAN (R 3.4.1)
##  memoise          1.1.0   2017-04-21 CRAN (R 3.4.0)
##  methods        * 3.4.1   2017-07-07 local
##  microbenchmark * 1.4-2.1 2015-11-25 CRAN (R 3.4.0)
##  multcomp         1.4-6   2016-07-14 CRAN (R 3.4.0)
##  munsell          0.4.3   2016-02-13 CRAN (R 3.4.0)
##  mvtnorm          1.0-6   2017-03-02 CRAN (R 3.4.0)
##  parallel         3.4.1   2017-07-07 local
##  plyr             1.8.4   2016-06-08 CRAN (R 3.4.0)
##  qtl            * 1.42-2  2017-09-13 local
##  qtl2geno       * 0.5-32  2017-09-15 local
##  Rcpp             0.12.12 2017-07-15 CRAN (R 3.4.1)
##  rlang            0.1.2   2017-08-09 CRAN (R 3.4.1)
##  rmarkdown        1.6     2017-06-15 CRAN (R 3.4.0)
##  rprojroot        1.2     2017-01-16 CRAN (R 3.4.0)
##  sandwich         2.4-0   2017-07-26 CRAN (R 3.4.1)
##  scales           0.5.0   2017-08-24 CRAN (R 3.4.1)
##  splines          3.4.1   2017-07-07 local
##  stats          * 3.4.1   2017-07-07 local
##  stringi          1.1.5   2017-04-07 CRAN (R 3.4.0)
##  stringr          1.2.0   2017-02-18 CRAN (R 3.4.0)
##  survival         2.41-3  2017-04-04 CRAN (R 3.4.0)
##  TH.data          1.0-8   2017-01-23 CRAN (R 3.4.0)
##  tibble           1.3.4   2017-08-22 CRAN (R 3.4.1)
##  tools            3.4.1   2017-07-07 local
##  utils          * 3.4.1   2017-07-07 local
##  withr            2.0.0   2017-07-28 CRAN (R 3.4.1)
##  yaml             2.1.14  2016-11-12 CRAN (R 3.4.0)
##  zoo              1.8-0   2017-04-12 CRAN (R 3.4.0)</code></pre>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

      </div>
      <hr>
      <footer>
        <p><small>
  <!-- start of Karl's footer; modify this part -->
          <a href="http://creativecommons.org/licenses/by/3.0/"><img src="http://i.creativecommons.org/l/by/3.0/88x31.png" alt="CC BY"/></a> &nbsp;
          <a href="http://kbroman.org">Karl Broman</a>
  <!-- end of Karl's footer; modify this part -->
        </small></p>
      </footer>

    </div>
